---
sidebar: sidebar 
permalink: concept_stor_vsan_external.html 
keywords: ontap select, vsan and external array configurations, vnas architecture 
summary: '虚拟 NAS (vNAS) 部署支持 vSAN 上的ONTAP Select集群、一些 HCI 产品、 NetApp HCI技术以及外部阵列类型的数据存储。这些配置的底层基础架构提供了数据存储的弹性。' 
---
= ONTAP SelectvSAN 和外部阵列配置
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
虚拟 NAS (vNAS) 部署支持虚拟 SAN (vSAN) 上的ONTAP Select集群、一些 HCI 产品以及外部阵列类型的数据存储。这些配置的底层基础架构提供了数据存储的弹性。

最低要求是您使用的虚拟机管理程序（在受支持的 Linux 主机上运行的 VMware ESXi 或 KVM）支持底层配置。如果虚拟机管理程序是 ESXi，则应将其列入相应的 VMware 硬件兼容性列表 (HCL) 中。



== vNAS 架构

vNAS 命名法适用于所有不使用 DAS 的设置。对于多节点ONTAP Select集群，这包括同一 HA 对中的两个ONTAP Select节点共享单个数据存储库（包括 vSAN 数据存储库）的架构。这些节点也可以安装在同一共享外部阵列的不同数据存储库上。这样可以提高阵列端存储效率，从而减少整个ONTAP Select HA 对的整体占用空间。ONTAPONTAP Select vNAS 解决方案的架构与带有本地 RAID 控制器的 DAS 上的ONTAP Select架构非常相似。也就是说，每个ONTAP Select节点都会继续拥有其 HA 伙伴节点数据的副本。ONTAP存储效率策略是节点范围的。因此，阵列端存储效率是可取的，因为它们可以应用于来自两个ONTAP Select节点的数据集。

HA 对中的每个ONTAP Select节点也可能使用单独的外部阵列。将ONTAP Select Metrocluster SDS 与外部存储结合使用时，这是一种常见的选择。

当为每个ONTAP Select节点使用单独的外部阵列时，两个阵列为ONTAP Select VM 提供相似的性能特征非常重要。



=== vNAS 架构与配备硬件 RAID 控制器的本地 DAS

从逻辑上讲，vNAS 架构与配备 DAS 和 RAID 控制器的服务器架构最为相似。在这两种情况下， ONTAP Select都会占用数据存储空间。该数据存储空间被划分为 VMDK，这些 VMDK 构成传统的ONTAP数据聚合。在集群创建和存储添加操作期间， ONTAP Deploy 会确保 VMDK 的大小正确，并分配给正确的丛（对于 HA 对）。

vNAS 与配备 RAID 控制器的 DAS 之间有两个主要区别。最直接的区别是 vNAS 不需要 RAID 控制器。vNAS 假设底层外部阵列能够提供配备 RAID 控制器的 DAS 所提供的数据持久性和弹性。第二个更细微的区别与NVRAM性能有关。



== vNAS NVRAM

ONTAP Select NVRAM是一种 VMDK。这意味着ONTAP Select在块寻址设备 (VMDK) 之上模拟字节寻址空间 (传统NVRAM)。然而， NVRAM的性能对于ONTAP Select节点的整体性能至关重要。

对于带有硬件 RAID 控制器的 DAS 设置，硬件 RAID 控制器缓存充当NVRAM缓存，因为对NVRAM VMDK 的所有写入都首先托管在 RAID 控制器缓存中。

对于 VNAS 架构， ONTAP Deploy 会自动使用名为“单实例数据日志记录 (SIDL)”的启动参数配置ONTAP Select节点。当此启动参数存在时， ONTAP Select会绕过NVRAM ，将数据负载直接写入数据聚合。NVRAMNVRAM用于记录 WRITE 操作更改的块的地址。此功能的优势在于避免了双重写入：一次写入NVRAM ，另一次写入NVRAM降级后。此功能仅适用于 vNAS，因为本地写入 RAID 控制器缓存的额外延迟可以忽略不计。

SIDL 功能并非与所有ONTAP Select存储效率功能兼容。可以使用以下命令在聚合级别禁用 SIDL 功能：

[listing]
----
storage aggregate modify -aggregate aggr-name -single-instance-data-logging off
----
请注意，如果关闭 SIDL 功能，写入性能会受到影响。禁用该聚合中所有卷上的所有存储效率策略后，可以重新启用 SIDL 功能：

[listing]
----
volume efficiency stop -all true -vserver * -volume * (all volumes in the affected aggregate)
----


== 在 ESXi 上使用 vNAS 时并置ONTAP Select节点

ONTAP Select支持在共享存储上部署多节点ONTAP Select集群。ONTAPONTAP支持在同一 ESX 主机上配置多个ONTAP Select节点，前提是这些节点不属于同一集群。请注意，此配置仅适用于 VNAS 环境（共享数据存储）。使用 DAS 存储时，不支持每个主机部署多个ONTAP Select实例，因为这些实例会争用同一个硬件 RAID 控制器。

ONTAP Deploy 确保多节点 VNAS 集群的初始部署不会将来自同一集群的多个ONTAP Select实例放置在同一主机上。下图展示了两个四节点集群在两台主机上交叉部署的正确示例。

多节点 VNAS 集群的初始部署

image:ST_14.jpg["多节点 VNAS 集群的初始部署"]

部署后， ONTAP Select节点可以在主机之间迁移。这可能会导致配置不理想且不受支持，因为同一集群中的两个或多个ONTAP Select节点共享同一底层主机。NetApp建议手动创建虚拟机反关联性规则，以便 VMware 自动维护同一集群中节点之间的物理隔离，而不仅仅是同一 HA 对中的节点之间的物理隔离。


NOTE: 反亲和性规则要求在 ESX 群集上启用 DRS。

请参阅以下示例，了解如何为ONTAP Select虚拟机创建反关联性规则。如果ONTAP Select集群包含多个 HA 对，则集群中的所有节点都必须包含在此规则中。

image:ST_15.jpg["虚拟机/主机规则"]

image:ST_16.jpg["编辑虚拟机/主机规则"]

由于以下原因之一，同一ONTAP Select集群中的两个或多个ONTAP Select节点可能会位于同一 ESX 主机上：

* 由于 VMware vSphere 许可证限制或未启用 DRS，因此不存在 DRS。
* 由于 VMware HA 操作或管理员启动的 VM 迁移优先，因此 DRS 反亲和性规则被绕过。


请注意， ONTAP Deploy 不会主动监控ONTAP Select虚拟机的位置。但是，集群刷新操作会在ONTAP Deploy 日志中反映出此不受支持的配置：

image:ST_17.PNG["ONTAP Deploy 日志"]
