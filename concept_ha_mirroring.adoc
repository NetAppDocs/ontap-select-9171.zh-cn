---
sidebar: sidebar 
permalink: concept_ha_mirroring.html 
keywords: ontap select, ha, high availability, synchronous replication, mirrored aggregates, write path, raid syncmirror, rsm 
summary: '使用 RAID SyncMirror (RSM)、镜像聚合和写入路径防止数据丢失。' 
---
= ONTAP Select HA RSM 和镜像聚合
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
使用 RAID SyncMirror (RSM)、镜像聚合和写入路径防止数据丢失。



== 同步复制

ONTAP高可用性 (HA) 模型建立在高可用性合作伙伴的概念之上。ONTAPONTAP Select将此架构扩展到非共享商用服务器领域，利用ONTAP中提供的 RAID SyncMirror (RSM) 功能在集群节点之间复制数据块，从而在高可用性 (HA) 对中提供两个用户数据副本。

带有调解器的双节点集群可以跨越两个数据中心。更多信息，请参阅该部分。link:reference_plan_best_practices.html#two-node-stretched-ha-metrocluster-sds-best-practices["双节点扩展 HA (MetroCluster SDS) 最佳实践"] 。



== 镜像聚合

ONTAP Select集群由 2 到 8 个节点组成。每个 HA 对包含两个用户数据副本，通过 IP 网络跨节点同步镜像。此镜像对用户透明，并且是数据聚合的一个属性，会在数据聚合创建过程中自动配置。

ONTAP Select集群中的所有聚合都必须进行镜像，以便在发生节点故障转移时确保数据可用性，并在发生硬件故障时避免出现单点故障 (SPOF)。ONTAPONTAP Select集群中的聚合基于 HA 对中每个节点提供的虚拟磁盘构建，并使用以下磁盘：

* 一组本地磁盘（由当前ONTAP Select节点提供）
* 一组镜像磁盘（由当前节点的 HA 伙伴提供）



NOTE: 用于构建镜像聚合的本地磁盘和镜像磁盘的大小必须相同。这些聚合称为丛 0 和丛 1（分别表示本地镜像对和远程镜像对）。实际的丛编号在您的安装中可能有所不同。

这种方法与标准ONTAP集群的工作方式有着根本的不同。这适用于ONTAP Select集群中的所有根磁盘和数据磁盘。聚合包含数据的本地副本和镜像副本。因此，包含 N 个虚拟磁盘的聚合可提供相当于 N/2 个磁盘的唯一存储，因为第二个数据副本位于其自己的唯一磁盘上。

下图显示了四节点ONTAP Select集群中的 HA 对。此集群中有一个聚合（测试），它使用来自两个 HA 配对节点的存储。此数据聚合由两组虚拟磁盘组成：一组本地磁盘，由ONTAP Select所属集群节点 (Plex 0) 提供；一组远程磁盘，由故障转移配对节点 (Plex 1) 提供。

Plex 0 是用于存放所有本地磁盘的存储桶。Plex1 是用于存放镜像磁盘（即负责存储用户数据第二个复制副本的磁盘）的存储桶。拥有聚合的节点会将磁盘提供给 Plex 0，而该节点的 HA 配对节点会将磁盘提供给 Plex 1。

下图中有一个包含两个磁盘的镜像聚合。此聚合的内容在两个集群节点之间进行镜像，本地磁盘 NET-1.1 放置在 Plex 0 存储桶中，远程磁盘 NET-2.1 放置在 Plex 1 存储桶中。在此示例中，聚合测试归左侧的集群节点所有，并使用本地磁盘 NET-1.1 和 HA 伙伴镜像磁盘 NET-2.1。

* ONTAP Select镜像聚合*image:DDHA_03.jpg["ONTAP Select镜像聚合"]


NOTE: 部署ONTAP Select集群时，系统上的所有虚拟磁盘都会自动分配给正确的 Plex，无需用户执行任何与磁盘分配相关的额外步骤。这可以防止磁盘意外分配给错误的 Plex，并提供最佳的镜像磁盘配置。



== 写入路径

集群节点之间的数据块同步镜像以及系统故障时不丢失数据的要求对传入写入操作在ONTAP Select集群中传播时所采用的路径有重大影响。此过程包含两个阶段：

* 致谢
* 降级


对目标卷的写入操作通过数据 LIF 进行，并提交到ONTAP Select节点系统磁盘上的虚拟化NVRAM分区，然后再向客户端确认。在 HA 配置中，还会执行一个额外的步骤，因为这些NVRAM写入操作会在确认之前立即镜像到目标卷所有者的 HA 配对节点。此过程可确保在原始节点发生硬件故障时，HA 配对节点上的文件系统保持一致。

将写入内容提交至NVRAM后， ONTAP会定期将此分区的内容移动到相应的虚拟磁盘，此过程称为降级转储。此过程仅在拥有目标卷的集群节点上发生一次，不会在 HA 配对节点上发生。

下图显示了传入ONTAP Select节点的写入请求的写入路径。

ONTAP Select写入路径工作流程*image:DDHA_04.jpg["ONTAP Select写入路径工作流程"]

传入写入确认包括以下步骤：

* 写入通过ONTAP Select节点 A 拥有的逻辑接口进入系统。
* 写入操作提交到节点 A 的NVRAM并镜像到 HA 伙伴节点 B。
* 当两个 HA 节点都出现 I/O 请求后，该请求就会被确认回客户端。


ONTAP Select从NVRAM降级到数据聚合 (ONTAP CP) 包括以下步骤：

* 写入操作从虚拟NVRAM转入虚拟数据聚合。
* 镜像引擎同步将块复制到两个 plex。

